import e from"ra-realtime";import t from"request-promise";import{Observable as r}from"rxjs";import{apps as n,initializeApp as i,app as s,firestore as a,auth as o}from"firebase/app";import"firebase/auth";import"firebase/firestore";import{CREATE as u,DELETE as c,DELETE_MANY as d,GET_LIST as l,GET_MANY as f,GET_MANY_REFERENCE as h,GET_ONE as p,UPDATE as m,UPDATE_MANY as y,AUTH_LOGIN as v,AUTH_LOGOUT as g,AUTH_ERROR as P,AUTH_CHECK as U,AUTH_GET_PERMISSIONS as b}from"react-admin";function j(e,t){w&&console.log(e,t)}var A,w=!1,F=function(e){this.resources={},this.app=n.length?s():i(e),this.db=this.app.firestore()};function O(e){if(!e)throw new Error("Please pass the Firebase config.json object to the FirebaseDataProvider");return w=e.debug,A=new F(e),function(e,t,r){try{return Promise.resolve(A.initPath(t)).then(function(){switch(e){case f:return A.apiGetMany(t,r);case h:return A.apiGetManyReference(t,r);case l:return A.apiGetList(t,r);case p:return A.apiGetOne(t,r);case u:return A.apiCreate(t,r);case m:return A.apiUpdate(t,r);case y:return A.apiUpdateMany(t,r);case c:return A.apiDelete(t,r);case d:return A.apiDeleteMany(t,r);default:return{}}})}catch(e){return Promise.reject(e)}}}F.prototype.parseFireStoreDocument=function(e){var t=e.data();return Object.keys(t).forEach(function(e){var r=t[e];r&&r.toDate&&r.toDate instanceof Function&&(t[e]=r.toDate().toISOString())}),Object.assign({},{id:e.id},t)},F.prototype.initPath=function(e){try{var t=this;return new Promise(function(r){if(t.resources[e])return r();var n=t.db.collection(e),i=t.getCollectionObservable(n);i.subscribe(function(n){var i=n.docs.map(function(e){return t.parseFireStoreDocument(e)});t.setList(i,e),r()});var s={collection:n,list:[],observable:i,path:e};t.resources[e]=s,j("initPath",{path:e,r:s,"this.resources":t.resources})})}catch(e){return Promise.reject(e)}},F.prototype.getFirebaseSource=function(e){try{return new Promise(function(t,r){a().collection(e).get().then(function(e){e.empty&&t([]);var r=[];e.forEach(function(e){r.push(Object.assign({},{id:e.id},e.data()))}),t(r)}).catch(function(e){r()})})}catch(e){return Promise.reject(e)}},F.prototype.insertDataInFirebaseWithId=function(e,t){try{return new Promise(function(r,n){var i=t.data.myId.toLowerCase(),s=a().collection(e).doc(i);delete t.data.myId,s.set(Object.assign({},t.data,{createdate:a.FieldValue.serverTimestamp(),lastupdate:a.FieldValue.serverTimestamp(),createdByUid:o().currentUser.uid,updatedByUid:o().currentUser.uid,createdByEmail:o().currentUser.email,updatedByEmail:o().currentUser.email})).then(function(){r({id:i})}).catch(function(e){n()})})}catch(e){return Promise.reject(e)}},F.prototype.addDataInFirebase=function(e,t){try{return new Promise(function(r,n){a().collection(e).add(Object.assign({},t.data,{createdate:a.FieldValue.serverTimestamp(),lastupdate:a.FieldValue.serverTimestamp(),createdByUid:o().currentUser.uid,updatedByUid:o().currentUser.uid,createdByEmail:o().currentUser.email,updatedByEmail:o().currentUser.email})).then(function(e){r({id:e.id})}).catch(function(e){n()})})}catch(e){return Promise.reject(e)}},F.prototype.updateDataInFirebase=function(e,t,r){try{return new Promise(function(n,i){a().collection(e).doc(r).set(Object.assign({},t.data,{lastupdate:a.FieldValue.serverTimestamp(),updatedByUid:o().currentUser.uid,updatedByEMail:o().currentUser.email})).then(function(e){n({id:r})}).catch(function(e){i()})})}catch(e){return Promise.reject(e)}},F.prototype.apiGetList=function(e,t){try{var r=this;return Promise.resolve(r.tryGetResource(e)).then(function(n){function i(){var e=t.pagination||{},r=e.page;void 0===r&&(r=1);var n=e.perPage;void 0===n&&(n=-1);var i=(r-1)*n;return{data:t.pagination?d.slice(i,i+n):d,total:d.length}}var s=n.list,a=t.sort||{},u=a.field;void 0===u&&(u="id");var c=a.order;void 0===c&&(c="asc"),r.sortArray(s,u,"asc"==c.toString().toLowerCase()?"asc":"desc"),j("apiGetList",{resourceName:e,resource:n,params:t});var d=r.filterArray(s,t.filter||{}),l=function(){if(-1!==["analysisActionsUsers","analysisDataUsers","analysisProductionUsers","analysisSystemUsers","analysisTeamUsers"].indexOf(e)){var n=r.filterArray(s,t.filter||{}).filter(function(e){return e.createdByUid===o().currentUser.uid&&!0===e.published});return Promise.resolve(r.getFirebaseSource(e.replace("Users",""))).then(function(e){var i=r.filterArray(e,t.filter||{}).filter(function(e){return!0===e.published}).filter(function(e){return n.filter(function(t){return t.questionId===e.id}).length<1}).map(function(e){return Object.assign({},e,{questionId:e.id})});d=n.concat(i)})}}();return l&&l.then?l.then(i):i()})}catch(e){return Promise.reject(e)}},F.prototype.apiGetOne=function(e,t){try{var r,n=this;function i(){if(r.length<1)throw new Error("react-admin-firebase: No id found matching: "+t.id);return{data:r.pop()}}var s=function(){if(-1!==["analysisActionsUsers","analysisDataUsers","analysisProductionUsers","analysisSystemUsers","analysisTeamUsers"].indexOf(e))return Promise.resolve(n.getFirebaseSource(e)).then(function(i){r=i.filter(function(e){return e.id===t.id});var s=function(){if(r.length<1)return Promise.resolve(n.getFirebaseSource(e.replace("Users",""))).then(function(e){r=(i=e).filter(function(e){return e.id===t.id}).map(function(e){return Object.assign({},e,{questionId:e.id})})})}();if(s&&s.then)return s.then(function(){})});var i=function(){if("users"===e&&!t.id)return Promise.resolve(n.tryGetResource(e)).then(function(e){r=e.list.filter(function(e){return e.id===o().currentUser.uid})});var i="profile"===e?Promise.resolve(n.getFirebaseSource("users")).then(function(e){var n=e.filter(function(e){return e.id===o().currentUser.uid});r=[],n.forEach(function(e){r.push(Object.assign({},e,{id:t.id}))})}):Promise.resolve(n.tryGetResource(e)).then(function(e){r=e.list.filter(function(e){return e.id===t.id})});return i&&i.then?i.then(function(){}):void 0}();return i&&i.then?i.then(function(){}):void 0}();return s&&s.then?s.then(i):i()}catch(e){return Promise.reject(e)}},F.prototype.apiCreate=function(e,t){try{var r=this;return Promise.resolve(r.tryGetResource(e)).then(function(n){return j("apiCreate",{resourceName:e,resource:n,params:t}),Promise.resolve(t.data.myId?r.insertDataInFirebaseWithId(e,t):n.collection.add(Object.assign({},t.data,{createdate:a.FieldValue.serverTimestamp(),lastupdate:a.FieldValue.serverTimestamp(),createdByUid:o().currentUser.uid,updatedByUid:o().currentUser.uid,createdByEmail:o().currentUser.email,updatedByEmail:o().currentUser.email}))).then(function(e){return{data:Object.assign({},t.data,{id:e.id})}})})}catch(e){return Promise.reject(e)}},F.prototype.apiUpdate=function(e,r){try{var n=this;function i(){j("apiUpdate",{resourceName:e,resource:s,params:r});var i=Object.assign({},r.data,{lastupdate:a.FieldValue.serverTimestamp(),updatedByUid:o().currentUser.uid,updatedByEMail:o().currentUser.email});if(-1!==["analysisActionsUsers","analysisDataUsers","analysisProductionUsers","analysisSystemUsers","analysisTeamUsers"].indexOf(e))return s.list.filter(function(e){return e.id===c}).length<1?(r.data.questionId=c,Promise.resolve(n.addDataInFirebase(e,r)).then(function(e){return Promise.resolve(t(u)).then(function(e){return{data:Object.assign({},r.data,{id:c})}})})):Promise.resolve(n.updateDataInFirebase(e,r,c)).then(function(e){return Promise.resolve(t(u)).then(function(e){return{data:Object.assign({},r.data,{id:c})}})});{function d(){return{data:Object.assign({},i,{id:c})}}var l=function(){if("profile"===e)return Promise.resolve(n.updateDataInFirebase("users",r,o().currentUser.uid)).then(function(){});var a="users"===e?(u.body.id=c,Promise.resolve(t(u)).then(function(e){return Promise.resolve(s.collection.doc(c).update(i)).then(function(){})})):Promise.resolve(s.collection.doc(c).update(i)).then(function(){});return a&&a.then?a.then(function(){}):void 0}();return l&&l.then?l.then(d):d()}}var s,u={method:"POST",uri:"https://us-central1-bandwitt-techreach.cloudfunctions.net/widgets/calculateScoring",body:{source:e,id:o().currentUser.uid},json:!0},c=r.id;delete r.data.id;var d="profile"===e?(s={},Promise.resolve(n.getFirebaseSource("users")).then(function(e){s.list=e})):Promise.resolve(n.tryGetResource(e)).then(function(e){s=e});return d&&d.then?d.then(i):i()}catch(e){return Promise.reject(e)}},F.prototype.apiUpdateMany=function(e,t){try{return delete t.data.id,Promise.resolve(this.tryGetResource(e)).then(function(r){j("apiUpdateMany",{resourceName:e,resource:r,params:t});for(var n=[],i=function(){var i=u[s];r.collection.doc(i).update(Object.assign({},t.data,{lastupdate:a.FieldValue.serverTimestamp(),updatedByUid:o().currentUser.uid,updatedByEmail:o().currentUser.email})),n.push(Object.assign({},t.data,{id:i})),-1!==["analysisActionsUsers","analysisDataUsers","analysisProductionUsers","analysisSystemUsers","analysisTeamUsers"].indexOf(e)&&(r.list.filter(function(e){return e.id===i}).length<1?a().collection(e).add(Object.assign({},t.data,{createdate:a.FieldValue.serverTimestamp(),createdByUid:o().currentUser.uid,createdByEmail:o().currentUser.email})):a().collection(e).doc(i).update(Object.assign({},t.data,{lastupdate:a.FieldValue.serverTimestamp(),updatedByUid:o().currentUser.uid,updatedByEmail:o().currentUser.email})))},s=0,u=t.ids;s<u.length;s+=1)i();return{data:n}})}catch(e){return Promise.reject(e)}},F.prototype.apiDelete=function(e,t){try{return Promise.resolve(this.tryGetResource(e)).then(function(r){return j("apiDelete",{resourceName:e,resource:r,params:t}),r.collection.doc(t.id).delete(),{data:t.previousData}})}catch(e){return Promise.reject(e)}},F.prototype.apiDeleteMany=function(e,t){try{var r=this;return Promise.resolve(r.tryGetResource(e)).then(function(n){j("apiDeleteMany",{resourceName:e,resource:n,params:t});for(var i=[],s=r.db.batch(),a=0,o=t.ids;a<o.length;a+=1){var u=o[a];s.delete(n.collection.doc(u)),i.push({id:u})}return s.commit(),{data:i}})}catch(e){return Promise.reject(e)}},F.prototype.apiGetMany=function(e,t){try{var r=this;function n(){return{data:i}}var i,s=new Set(t.ids),a=-1!==["analysisActionsUsers","analysisDataUsers","analysisProductionUsers","analysisSystemUsers","analysisTeamUsers"].indexOf(e)?Promise.resolve(r.getFirebaseSource(e)).then(function(t){i=t.filter(function(e){return s.has(e.id)});var n=function(){if(i.length<1)return Promise.resolve(r.getFirebaseSource(e.replace("Users",""))).then(function(e){i=e.filter(function(e){return s.has(e.id)})})}();if(n&&n.then)return n.then(function(){})}):Promise.resolve(r.tryGetResource(e)).then(function(e){i=e.list.filter(function(e){return s.has(e.id)})});return a&&a.then?a.then(n):n()}catch(e){return Promise.reject(e)}},F.prototype.apiGetManyReference=function(e,t){try{var r,n=this;function i(){if(null!=t.sort){var e=t.sort;n.sortArray(r,e.field,"ASC"===e.order?"asc":"desc")}var i=(t.pagination.page-1)*t.pagination.perPage;return{data:s.slice(i,i+t.pagination.perPage),total:s.length}}var s,a=t.target,o=t.id,u=-1!==["analysisActionsUsers","analysisDataUsers","analysisProductionUsers","analysisSystemUsers","analysisTeamUsers"].indexOf(e)?Promise.resolve(n.getFirebaseSource(e)).then(function(t){s=(r=t).filter(function(e){return e[a]===o});var i=function(){if(s.length<1)return Promise.resolve(n.getFirebaseSource(e.replace("Users",""))).then(function(e){s=(r=e).filter(function(e){return e[a]===o})})}();if(i&&i.then)return i.then(function(){})}):Promise.resolve(n.tryGetResource(e)).then(function(e){s=(r=e.list).filter(function(e){return e[a]===o})});return u&&u.then?u.then(i):i()}catch(e){return Promise.reject(e)}},F.prototype.GetResource=function(e){return this.tryGetResource(e)},F.prototype.sortArray=function(e,t,r){e.sort(function(e,n){var i=e[t]?e[t].toString().toLowerCase():"",s=n[t]?n[t].toString().toLowerCase():"";return i>s?"asc"===r?-1:1:i<s?"asc"===r?1:-1:0})},F.prototype.filterArray=function(e,t){if("{}"==JSON.stringify(t))return e;var r=Object.keys(t);return e.filter(function(e){return r.reduce(function(r,n){var i=t[n].toLowerCase(),s=e[n];if(null==s)return!1;var a=s.toLowerCase().includes(i);return r||a},!1)})},F.prototype.setList=function(e,t){try{return Promise.resolve(this.tryGetResource(t)).then(function(t){t.list=e})}catch(e){return Promise.reject(e)}},F.prototype.tryGetResource=function(e){var t=this.resources[e];if(!t)throw new Error('react-admin-firebase: Cant find resource: "'+e+'"');return t},F.prototype.getCollectionObservable=function(e){return r.create(function(t){return e.onSnapshot(t)})};var S=function(t,r){return e(function(e,t){return function(r,n,i){if((!t||!Array.isArray(t.watch)||t.watch.includes(n))&&!(t&&Array.isArray(t.dontwatch)&&t.dontwatch.includes(n)))return{subscribe:function(t){var s=A.GetResource(n).observable.subscribe(function(){e(r,n,i).then(function(e){return t.next(e)}).catch(function(e){return t.error(e)})});return{unsubscribe:function(){s.unsubscribe()}}}}}}(t,r))};function D(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function E(e,t){G&&console.log("FirebaseAuthProvider: "+e,t)}var G=!1,B=function(e){E("Auth Client: initializing..."),this.app=n.length?s():i(e),this.auth=o(),this.db=this.app.firestore()};function C(e){if(!e)throw new Error("Please pass the Firebase config.json object to the FirebaseAuthProvider");G=e.debug;var t=new B(e);return function(e,r){try{switch(E("Auth Event: ",{type:e,params:r}),e){case v:return Promise.resolve(t.HandleAuthLogin(r)).then(function(){});case g:return Promise.resolve(t.HandleAuthLogout(r)).then(function(){});case P:return Promise.resolve(t.HandleAuthError(r)).then(function(){});case U:return Promise.resolve(t.HandleAuthCheck(r)).then(function(){});case b:return Promise.resolve(t.getPermissions());default:throw new Error("Unhandled auth type:"+e)}}catch(e){return Promise.reject(e)}}}B.prototype.HandleAuthLogin=function(e){try{var t=this,r=e.username,n=e.password;return console.log("HandleAuthLogin......"),D(function(){return console.log("no hay token,signInWithEmailAndPassword"),Promise.resolve(t.auth.signInWithEmailAndPassword(r,n)).then(function(e){E("HandleAuthLogin: user sucessfully logged in",{user:e})})},function(){throw E("HandleAuthLogin: invalid credentials",{params:e}),new Error("Login error: invalid credentials")})}catch(e){return Promise.reject(e)}},B.prototype.HandleAuthLogout=function(e){try{return console.log("HandleAuthLogout"),Promise.resolve(this.auth.signOut()).then(function(){})}catch(e){return Promise.reject(e)}},B.prototype.HandleAuthError=function(e){},B.prototype.HandleAuthCheck=function(e){try{var t=this;return D(function(){return Promise.resolve(t.getUserLogin()).then(function(e){E("HandleAuthCheck: user is still logged in",{user:e}),console.log("HandleAuthCheck: user is still logged in",{user:e})})},function(e){return E("HandleAuthCheck: ",{e:e}),console.log("HandleAuthCheck: ",{e:e}),Promise.reject()})}catch(e){return Promise.reject(e)}},B.prototype.getUserLogin=function(){try{var e=this;return new Promise(function(t,r){e.auth.onAuthStateChanged(function(e){e?t(e):r("User not logged in")})})}catch(e){return Promise.reject(e)}},B.prototype.getPermissions=function(){try{var e=this;return new Promise(function(t,r){e.auth.onAuthStateChanged(function(e){e?a().collection("users").doc(e.uid||"").get().then(function(e){t(e.exists&&e.data().isAdmin?"admin":"user")}).catch(function(e){console.log("Error getting document",e),r()}):(console.log("no hay permisos......"),t("guest"))})})}catch(e){return Promise.reject(e)}},B.prototype.getUserPermissions=function(e){try{return new Promise(function(t,r){a().collection("users").doc(e).get().then(function(e){t(!!e.exists&&e.data().isAdmin)}).catch(function(e){console.log("Error getting document",e),r()})})}catch(e){return Promise.reject(e)}};export{S as FirebaseRealTimeSaga,O as FirebaseDataProvider,C as FirebaseAuthProvider};
//# sourceMappingURL=index.mjs.map
